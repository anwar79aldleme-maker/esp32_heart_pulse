<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PPG Live Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  margin:0;
  background:#050b14;
  color:#00ff9c;
  font-family:Segoe UI;
}
header {
  padding:15px;
  text-align:center;
  font-size:22px;
  box-shadow:0 0 20px #00ff9c;
}
.card {
  margin:20px;
  background:rgba(0,0,0,0.6);
  padding:20px;
  border-radius:16px;
  box-shadow:0 0 25px rgba(0,255,150,0.3);
}
.value {
  font-size:42px;
  text-align:center;
  margin-bottom:10px;
}
canvas {
  height:320px !important;
}
</style>
</head>

<body>

<header>ðŸ«€ Live PPG Waveform & BPM</header>

<div class="card">
  <div class="value" id="bpmValue">-- BPM</div>
  <canvas id="ppgChart"></canvas>
</div>

<script>
// =========================
// Variables
// =========================
const MAX_POINTS = 300;
let labels = [];
let signalData = [];

// =========================
// Chart.js
// =========================
const ctx = document.getElementById('ppgChart').getContext('2d');
const chart = new Chart(ctx,{
  type:'line',
  data:{
    labels,
    datasets:[{
      data: signalData,
      borderColor:'#00ff9c',
      borderWidth:2,
      pointRadius:0,
      tension:0.15,
      fill:true,
      backgroundColor:'rgba(0,255,156,0.15)'
    }]
  },
  options:{
    animation:false,
    responsive:true,
    scales:{
      x:{display:false},
      y:{
        suggestedMin:1800,
        suggestedMax:2600
      }
    }
  }
});

// =========================
// Signal Filter (Low-pass)
// =========================
let lastFiltered = 0;
function filterSignal(v){
  const alpha = 0.85;
  const filtered = alpha * lastFiltered + (1 - alpha) * v;
  lastFiltered = filtered;
  return filtered;
}

// =========================
// Peak Detection â†’ BPM
// =========================
let lastPeakTime = 0;
let prevSignal = 0;
let bpm = null;

function detectPeak(signal){
  const threshold = 30;
  const now = Date.now();

  if (
    signal - prevSignal > threshold &&
    signal > 2000 &&
    (now - lastPeakTime) > 300
  ) {
    if (lastPeakTime !== 0) {
      const ibi = now - lastPeakTime;
      bpm = Math.round(60000 / ibi);
    }
    lastPeakTime = now;
  }

  prevSignal = signal;
}

// =========================
// Fetch Data from API
// =========================
async function update(){
  try {
    const res = await fetch('/api/pulse');
    const data = await res.json();
    if(!data.length) return;

    const last = data[data.length - 1];
    let rawSignal = last.signal;

    // Filter
    let signal = filterSignal(rawSignal);

    // Update chart
    signalData.push(signal);
    labels.push('');

    if(signalData.length > MAX_POINTS){
      signalData.shift();
      labels.shift();
    }

    detectPeak(signal);
    chart.update();

    if(bpm && bpm >= 40 && bpm <= 180){
      document.getElementById('bpmValue').innerText = bpm + " BPM";
    }

  } catch(e){
    console.error(e);
  }
}

// =========================
// Loop (50Hz)
// =========================
setInterval(update, 20);
</script>

</body>
</html>

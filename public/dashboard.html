<!DOCTYPE html>
<html>
<head>
  <title>Heart Signal</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h2>BPM: <span id="bpm">--</span></h2>
<canvas id="chart"></canvas>

<script>
let data = [];
let labels = [];
let lastPeak = 0;
let bpm = 0;

const ctx = document.getElementById("chart");
const chart = new Chart(ctx, {
  type: "line",
  data: {
    labels,
    datasets: [{
      label: "Signal",
      data,
      borderWidth: 2,
      pointRadius: 0
    }]
  },
  options: {
    animation: false,
    scales: {
      y: { min: 0, max: 4095 }
    }
  }
});

async function fetchData() {
  const res = await fetch("/api/latest");
  const json = await res.json();

  json.signal.forEach(v => {
    data.push(v);
    labels.push("");

    // Peak detection (بسيطة لكنها فعالة)
    if (v > 2500 && Date.now() - lastPeak > 400) {
      bpm = Math.round(60000 / (Date.now() - lastPeak));
      lastPeak = Date.now();
      document.getElementById("bpm").innerText = bpm;
    }

    if (data.length > 300) {
      data.shift();
      labels.shift();
    }
  });

  chart.update();
}

setInterval(fetchData, 100);
</script>

</body>
</html>

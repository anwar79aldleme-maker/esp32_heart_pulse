<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Heart Pulse Dashboard (IBI)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  background:#050b14;
  color:#00ff9c;
  font-family:Segoe UI;
}
header{
  padding:15px;
  text-align:center;
  font-size:22px;
  box-shadow:0 0 20px #00ff9c;
}
.card{
  margin:20px;
  background:rgba(0,0,0,.6);
  padding:20px;
  border-radius:16px;
  box-shadow:0 0 25px rgba(0,255,150,.3);
}
.value{
  font-size:42px;
  text-align:center;
  margin-bottom:10px;
}
canvas{
  height:300px !important;
}
</style>
</head>

<body>

<header>ğŸ«€ Live Heart Pulse (IBI)</header>

<div class="card">
  <div class="value" id="bpmValue">-- BPM</div>
  <canvas id="pulseChart"></canvas>
</div>

<script>
// ===============================
// CONFIG
// ===============================
const API_URL = "https://esp32heartpulseonedevice.vercel.app/api/pulse";
const MAX_POINTS = 120;

// ===============================
// DATA
// ===============================
let labels = [];
let pulseData = [];
let bpm = null;

// ===============================
// Chart.js
// ===============================
const ctx = document.getElementById("pulseChart").getContext("2d");
const chart = new Chart(ctx,{
  type:"line",
  data:{
    labels,
    datasets:[{
      data:pulseData,
      borderColor:"#00ff9c",
      borderWidth:2,
      tension:0.4,
      pointRadius:0,
      fill:true,
      backgroundColor:"rgba(0,255,156,.15)"
    }]
  },
  options:{
    animation:false,
    responsive:true,
    scales:{
      x:{display:false},
      y:{
        suggestedMin:400,
        suggestedMax:1200,
        title:{
          display:true,
          text:"IBI (ms)"
        }
      }
    }
  }
});

// ===============================
// IBI â†’ BPM
// ===============================
function calculateBPM(ibi){
  return Math.round(60000 / ibi);
}

// ===============================
// Create Pulse Shape from IBI
// ===============================
function generatePulse(ibi){
  /*
   Ù†Ø­ÙˆÙ„ ÙƒÙ„ Ù†Ø¨Ø¶Ø© Ø¥Ù„Ù‰ Ø´ÙƒÙ„ Ù…ÙˆØ¬Ø©:
   Ø§Ø±ØªÙØ§Ø¹ â†’ Ù‡Ø¨ÙˆØ· (pseudo ECG / pulse)
  */
  const samples = 5;
  let wave = [];

  for(let i=0;i<samples;i++){
    let value;
    if(i < samples/2){
      value = ibi - i*20;
    } else {
      value = ibi - (samples-i)*20;
    }
    wave.push(value);
  }
  return wave;
}

// ===============================
// Fetch & Update
// ===============================
async function update(){
  try{
    const res = await fetch(API_URL);
    const data = await res.json();
    if(!Array.isArray(data) || data.length===0) return;

    const last = data[data.length-1];

    if(typeof last.ibi !== "number") return;

    bpm = calculateBPM(last.ibi);
    document.getElementById("bpmValue").innerText = bpm + " BPM";

    // ØªÙˆÙ„ÙŠØ¯ Ø´ÙƒÙ„ Ø§Ù„Ù†Ø¨Ø¶Ø©
    const pulseWave = generatePulse(last.ibi);

    pulseWave.forEach(v=>{
      pulseData.push(v);
      labels.push("");
    });

    while(pulseData.length > MAX_POINTS){
      pulseData.shift();
      labels.shift();
    }

    chart.update();

  }catch(err){
    console.error("Dashboard error:", err);
  }
}

// ===============================
// Loop
// ===============================
setInterval(update, 300); // ÙƒÙ„ Ù†Ø¨Ø¶Ø© ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§
</script>

</body>
</html>

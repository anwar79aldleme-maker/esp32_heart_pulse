
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Heart Pulse Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h2>Heart Pulse Signal</h2>
<h3 id="bpm">BPM: --</h3>

<canvas id="chart" width="400" height="200"></canvas>

<script>
const ctx = document.getElementById("chart").getContext("2d");

const data = {
  labels: [],
  datasets: [{
    label: "Signal",
    data: [],
    borderWidth: 2,
    fill: false,
    tension: 0.3
  }]
};

const chart = new Chart(ctx, {
  type: "line",
  data: data,
  options: {
    animation: false,
    scales: {
      y: { min: 0, max: 4095 }
    }
  }
});

// =======================
// BPM from Signal (Peaks)
// =======================
function calculateBPM(signal, fs = 50) {
  const threshold = 2600;   // عدّلها حسب الإشارة
  let peaks = [];

  for (let i = 1; i < signal.length - 1; i++) {
    if (
      signal[i] > threshold &&
      signal[i] > signal[i - 1] &&
      signal[i] > signal[i + 1]
    ) {
      peaks.push(i);
    }
  }

  if (peaks.length < 2) return "--";

  let intervals = [];
  for (let i = 1; i < peaks.length; i++) {
    intervals.push((peaks[i] - peaks[i - 1]) / fs);
  }

  const avgInterval =
    intervals.reduce((a, b) => a + b, 0) / intervals.length;

  return Math.round(60 / avgInterval);
}

// =======================
// Fetch data
// =======================
async function fetchData() {
  const res = await fetch("/api/latest");
  const samples = await res.json();

  data.labels = [];
  data.datasets[0].data = [];

  samples.forEach(s => {
    data.labels.push("");
    data.datasets[0].data.push(s.signal);
  });

  chart.update();

  const bpm = calculateBPM(data.datasets[0].data);
  document.getElementById("bpm").innerText = "BPM: " + bpm;
}

setInterval(fetchData, 1000);
</script>

</body>
</html>

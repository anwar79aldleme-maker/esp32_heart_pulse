<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ECG Dashboard</title>
<style>
body { background:#0b1220; color:#00ffcc; text-align:center; }
canvas { background:black; border:1px solid #00ffcc; }
</style>
</head>
<body>

<h2>Live ECG</h2>
<p id="info">Waiting...</p>
<canvas id="ecg" width="900" height="300"></canvas>

<script>
const canvas = document.getElementById("ecg");
const ctx = canvas.getContext("2d");
let signal = [];

function draw() {
  ctx.clearRect(0,0,900,300);
  ctx.beginPath();

  for (let i = 0; i < signal.length; i++) {
    let x = i * (900 / signal.length);
    let y = 300 - (signal[i] / 4095) * 280;
    if (i === 0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  }

  ctx.strokeStyle = "#00ffcc";
  ctx.stroke();
}

function calcBPM(data) {
  let peaks = 0;
  const th = 2000;
  for (let i = 1; i < data.length - 1; i++) {
    if (data[i] > th && data[i] > data[i-1] && data[i] > data[i+1])
      peaks++;
  }
  return peaks * 6;
}

async function update() {
  const res = await fetch("/api/pulse");
  const json = await res.json();
  signal = json.signal || [];

  if (signal.length > 50) {
    draw();
    document.getElementById("info").innerText =
      "BPM: " + calcBPM(signal);
  }
}

setInterval(update, 100);
setInterval(draw, 33);
</script>

</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PPG Live Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  margin:0;
  background:#050b14;
  color:#00ff9c;
  font-family:Segoe UI;
}
header {
  padding:15px;
  text-align:center;
  font-size:22px;
  box-shadow:0 0 20px #00ff9c;
}
.card {
  margin:20px;
  background:rgba(0,0,0,0.6);
  padding:20px;
  border-radius:16px;
  box-shadow:0 0 25px rgba(0,255,150,0.3);
}
.value {
  font-size:42px;
  text-align:center;
  margin-bottom:10px;
}
canvas { height:320px !important; }
</style>
</head>

<body>
<header>ðŸ«€ PPG Live Signal & BPM</header>

<div class="card">
  <div class="value" id="bpmValue">-- BPM</div>
  <canvas id="ppgChart"></canvas>
</div>

<script>
const MAX_POINTS = 300;   // Ø¹Ø¯Ø¯ Ù†Ù‚Ø§Ø· Ø§Ù„Ø±Ø³Ù…
let labels = [];
let data = [];
let bpmValues = [];

// =========================
// Chart.js setup
// =========================
const ctx = document.getElementById('ppgChart').getContext('2d');
const chart = new Chart(ctx,{
  type:'line',
  data:{labels,datasets:[{
    data,
    borderColor:'#00ff9c',
    borderWidth:2,
    pointRadius:0,
    tension:0.2
  }]},
  options:{
    animation:false,
    responsive:true,
    scales:{
      x:{ display:false },
      y:{ min:0, max:4095 }  // <- Ø¹Ø¯Ù‘Ù„ Ù‡Ø°Ø§ Ø­Ø³Ø¨ ADC Ø§Ù„Ø¨Ù†
    }
  }
});

// =========================
// Simple Moving Average Filter
// =========================
function smoothSignal(signal, windowSize=5){
  if(data.length<windowSize) return signal;
  let sum=0;
  for(let i=data.length-windowSize;i<data.length;i++){
    sum+=data[i];
  }
  return (sum + signal)/(windowSize+1);
}

// =========================
// Peak Detection for BPM
// =========================
let lastPeakTime = 0;
let peakTimes = [];

function detectPeak(signal){
  const threshold = 1400; // Ø¹Ø¯Ù‘Ù„ Ø­Ø³Ø¨ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¥Ø´Ø§Ø±Ø©
  const now = Date.now();

  if(signal > threshold){
    if(lastPeakTime===0 || (now - lastPeakTime) > 300){ // Ù„Ø§ ÙŠÙ‚Ù„ Ø¹Ù† 300ms Ø¨ÙŠÙ† Ø§Ù„Ù†Ø¨Ø¶Ø§Øª
      lastPeakTime = now;
      peakTimes.push(now);

      if(peakTimes.length>10) peakTimes.shift();

      if(peakTimes.length>=2){
        let intervals = [];
        for(let i=1;i<peakTimes.length;i++){
          intervals.push(peakTimes[i]-peakTimes[i-1]);
        }
        let avgInterval = intervals.reduce((a,b)=>a+b,0)/intervals.length;
        let bpm = Math.round(60000/avgInterval);
        return bpm;
      }
    }
  }
  return null;
}

// =========================
// Fetch signal and update
// =========================
async function update(){
  try {
    const res = await fetch('/api/pulse');
    const arr = await res.json();
    if(!arr.length) return;

    // Ø¢Ø®Ø± Ø¥Ø´Ø§Ø±Ø©
    let signal = arr[arr.length-1].signal;

    // smooth
    signal = smoothSignal(signal,5);

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ù…
    data.push(signal);
    labels.push('');
    if(data.length>MAX_POINTS){ data.shift(); labels.shift(); }

    // detect BPM
    const bpm = detectPeak(signal);
    if(bpm) bpmValues.push(bpm);

    chart.update();

    // Ø¹Ø±Ø¶ BPM Ø§Ù„Ø­Ø§Ù„ÙŠ
    if(bpmValues.length>0){
      document.getElementById('bpmValue').innerText = bpmValues[bpmValues.length-1] + " BPM";
    }
  } catch(e){
    console.error(e);
  }
}

// =========================
// Loop
// =========================
setInterval(update,20); // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 20ms â‰ˆ 50Hz
</script>

</body>
</html>

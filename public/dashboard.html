<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Heart Pulse Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<h2>Heart Signal</h2>
<h3 id="bpm">BPM: --</h3>
<canvas id="chart" width="600" height="300"></canvas>

<script>
const ctx = document.getElementById("chart").getContext("2d");

const data = {
  labels: [],
  datasets: [{
    label: "Signal",
    data: [],
    borderColor: "red",
    fill: false,
    tension: 0.2,
    pointRadius: 0
  }]
};

const chart = new Chart(ctx, {
  type: "line",
  data: data,
  options: { animation: false, scales: { y: { min: 0, max: 4095 } } }
});

function calculateBPM(signal, fs=50){
  const threshold = 2600;
  let peaks = [];
  for(let i=1;i<signal.length-1;i++){
    if(signal[i]>threshold && signal[i]>signal[i-1] && signal[i]>signal[i+1]) peaks.push(i);
  }
  if(peaks.length<2) return "--";
  let intervals = [];
  for(let i=1;i<peaks.length;i++) intervals.push((peaks[i]-peaks[i-1])/fs);
  const avgInterval = intervals.reduce((a,b)=>a+b,0)/intervals.length;
  return Math.round(60/avgInterval);
}

async function fetchData(){
  try {
    const res = await fetch("/api/latest?device_id=max1");
    if(!res.ok) return;
    const samples = await res.json();
    data.labels = samples.map(()=> "");
    data.datasets[0].data = samples.map(s=> s.signal);
    chart.update();
    const bpm = calculateBPM(data.datasets[0].data);
    document.getElementById("bpm").innerText = "BPM: "+bpm;
  } catch(e){
    console.log("Fetch error", e);
  }
}

setInterval(fetchData,1000);
</script>
</body>
</html>
